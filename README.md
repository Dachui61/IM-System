# IMSystem

## 项目简介

IMSystem 是一个分布式即时通讯系统，旨在提供高性能、高可靠性的实时聊天服务。系统包含基于 Qt 的前端客户端和分布式后端架构，支持用户身份认证、好友管理、单聊、群聊、文件传输、离线消息等功能。

---

## 功能模块

### **1. 前端（Qt 客户端）**

#### 职责
- 提供用户界面。
- 通过 WebSocket 与服务器保持长连接，实时收发消息。
- 提供用户身份认证、消息展示、消息发送等功能。

#### 功能模块
1. **用户登录/注册界面**
   - 通过 HTTP 请求将用户认证数据发送到服务器。
   - 成功后使用 WebSocket 建立长连接。

2. **好友列表**
   - 显示好友状态（在线/离线）。
   - 允许用户选择好友进行聊天。

3. **聊天窗口**
   - 实时显示聊天记录。
   - 支持文本、表情、文件发送。

4. **消息通知**
   - 在消息接收时显示通知（如弹窗提示）。

#### 技术实现
- 使用 `QWebSocket` 管理长连接。
- 使用 `Qt Widgets` 或 `Qt Quick` 设计界面。
- 使用 `QJsonDocument` 处理消息的 JSON 格式。

---

### **2. 后端（分布式 WebSocket 长连接服务器）**

#### 职责
- 处理客户端 WebSocket 连接。
- 维护用户的在线状态。
- 转发消息到目标客户端。
- 提供历史消息的存储和查询。

#### 功能模块
1. **用户认证**
   - 使用 OAuth2.0 或基于 JWT 的认证方案。
   - WebSocket 握手时携带有效认证信息，防止未经认证的连接。

2. **消息转发**
   - 优化消息路由，通过用户 ID 分片将连接分配到不同的服务器。
   - 使用 Redis Pub/Sub 或 Kafka 处理消息广播和点对点转发。

3. **离线消息支持**
   - 持久化离线消息到数据库或缓存（如 Redis）。
   - 用户上线后，通过事件触发推送未读消息。

4. **心跳检测**
   - 定期发送心跳包，检测客户端是否在线。
   - 客户端断线后，标记用户离线并释放资源。

#### 分布式架构补充
1. **网关服务器**
   - 功能：统一管理 WebSocket 连接，进行流量分发和负载均衡。
   - 技术：使用 Nginx 或 Envoy 配合 Consul 或 Eureka 实现服务发现和注册。

2. **验证服务器**
   - 专门负责用户认证和授权，与主 WebSocket 服务器分离。

3. **高可用性**
   - WebSocket 服务器支持负载均衡（如 HAProxy）和弹性扩容。

---

### **3. 数据库设计**

#### 职责
- 存储用户信息、好友关系、聊天记录等数据。

#### 数据库技术选型
1. **主数据库：MySQL**
   - 存储用户数据、好友关系、群组和聊天记录。
   - 支持分片和主从复制，提供高可靠性和扩展性。

2. **缓存数据库：Redis**
   - 用于会话状态、用户在线状态和离线消息缓存。
   - 提供快速的读写性能，减轻主数据库压力。

3. **时间序列数据库：InfluxDB**
   - 优化历史消息查询，支持按时间范围高效检索。
   - 适合长时间存储和查询聊天记录。

#### 表设计
1. **用户表（users）**
   - 存储用户的基本信息，如用户名、密码、在线状态等。
2. **好友关系表（friends）**
   - 管理用户之间的好友关系。
3. **消息表（messages）**
   - 设计兼容单聊和群聊。
4. **文件存储表（files）**
   - 存储文件元信息（文件名、大小、路径等）。
5. **群组及成员表**
   - 存储群组信息及成员关系。

---

### **4. 消息中间件**

#### 职责
- 缓解后端服务器的压力。
- 提供可靠的消息传递机制。

#### 技术选型
1. **Redis Pub/Sub**
   - 简单高效，适合用户在线消息转发。
2. **Kafka**
   - 高吞吐量和可靠性，适合海量历史消息存储和离线消息推送。

---

### **5. 系统设计要点**

#### 安全性
1. **通信安全**
   - WebSocket 使用 WSS（WebSocket over TLS）。
   - 数据库存储敏感信息时加密（如 AES）。
2. **防止滥用**
   - 限制 WebSocket 最大连接数。
   - API 提供速率限制（Rate Limiting）。
3. **敏感操作验证**
   - 添加好友、修改密码等关键操作使用双向验证。

#### 扩展性
1. **数据库分片**
   - 根据用户 ID 或消息时间进行分表。
2. **分布式缓存**
   - 使用 Redis Cluster 提供可扩展的缓存。
3. **横向扩展**
   - 所有服务无状态化，支持容器化部署（如 Kubernetes）。

---

## 部署与运行

### 使用 Docker 部署

1. **安装 Docker 和 Docker Compose**
   - 请确保系统已安装 Docker 和 Docker Compose。

2. **构建和运行服务**
   ```bash
   docker-compose up --build
   ```

3. **数据库初始化**
   - 系统会自动执行 `init.sql` 初始化数据库结构。

### 开发环境
- 后端：C++（使用 Boost.Beast 实现 WebSocket）
- 数据库：MySQL、Redis、InfluxDB
- 消息队列：Redis Pub/Sub
- 前端：Qt + QWebSocket

---

## TODO
- 优化文件传输支持大文件的分块上传与下载。
- 实现更多消息类型（如音频、视频）。
- 支持更多存储后端（如对象存储）。

---
